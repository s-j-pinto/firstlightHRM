
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Utility functions to make rules more readable.
    function isStaffingAdmin() {
      return request.auth.token.email == resource.data.staffing_admin_email;
    }
    function isHrAdmin() {
      return request.auth.token.email == resource.data.hr_admin_email;
    }
    function isOwner() {
      return request.auth.token.email == resource.data.owner_email;
    }
    function isAnyAdmin() {
      return isStaffingAdmin() || isHrAdmin() || isOwner();
    }
    function isAnonymousUser() {
      return request.auth.provider == 'anonymous';
    }
    function isActiveCaregiver() {
      let isCaregiver = exists(/databases/$(database)/documents/caregivers_active/$(request.auth.uid));
      let isActive = get(/databases/$(database)/documents/caregivers_active/$(request.auth.uid)).data.status == 'ACTIVE';
      return isCaregiver && isActive;
    }
    function isClientUser() {
      // A client user is identified by the presence of a 'clientId' claim.
      return request.auth.token.clientId != null;
    }
    
    // Global settings, only readable by admins.
    match /settings/{settingId} {
      allow read: if isAnyAdmin();
      allow write: if isHrAdmin(); // Only HR Admin can change availability.
    }
    
    // Email documents for the 'firestore-send-email' extension.
    match /mail/{docId} {
        allow create; // Allow anyone to queue an email.
    }

    // Caregiver application profiles.
    match /caregiver_profiles/{caregiverProfileId} {
      // An anonymous user can create their own profile.
      allow create: if isAnonymousUser() && request.resource.data.uid == request.auth.uid;
      
      // Admins can read, update, and delete any profile.
      allow read, update, delete: if isAnyAdmin();
    }
    
    // Appointments for interviews.
    match /appointments/{appointmentId} {
        // An anonymous user can create their own appointment.
        allow create: if isAnonymousUser() && request.resource.data.caregiverId == request.resource.data.caregiverId;
        
        // Admins can manage all appointments.
        allow read, write, delete: if isHrAdmin();
    }
    
    // Interview records.
    match /interviews/{interviewId} {
      allow read, write: if isAnyAdmin();
    }

    // Hired employee records.
    match /caregiver_employees/{employeeId} {
      allow read, write: if isAnyAdmin();
    }

    // Active caregiver records (synced from external system).
    match /caregivers_active/{caregiverId} {
      allow read: if isAnyAdmin() || isActiveCaregiver();
      allow write: if isAnyAdmin(); // Only admins can modify this collection.
    }

    // Client records (synced from external system).
    match /Clients/{clientId} {
      allow read, write: if isAnyAdmin();
    }

    // Groups linking clients and caregivers.
    match /carelog_groups/{groupId} {
        allow read: if isAnyAdmin() || isActiveCaregiver() || isClientUser();
        allow write: if isStaffingAdmin();
    }
    
    // Individual care log entries.
    match /carelogs/{logId} {
      // An active caregiver can create a log for a group they are part of.
      allow create: if isActiveCaregiver() && 
                      request.auth.token.email in get(/databases/$(database)/documents/carelog_groups/$(request.resource.data.careLogGroupId)).data.caregiverEmails;
                      
      // A client can read logs for their group IF client access is enabled for that group.
      allow read: if (isClientUser() && 
                     request.auth.token.clientId == get(/databases/$(database)/documents/carelog_groups/$(resource.data.careLogGroupId)).data.clientId &&
                     get(/databases/$(database)/documents/carelog_groups/$(resource.data.careLogGroupId)).data.clientAccessEnabled == true) ||
                    (isActiveCaregiver() && request.auth.token.email in get(/databases/$(database)/documents/carelog_groups/$(resource.data.careLogGroupId)).data.caregiverEmails) ||
                    isStaffingAdmin();
    }

    // Templates for structured care logs.
    match /carelog_templates/{templateId} {
        allow read: if isStaffingAdmin() || isActiveCaregiver();
        allow write: if isStaffingAdmin();
    }
    
    // Requests from clients for additional care.
    match /client_additional_care_requests/{requestId} {
        // A client user can create their own request.
        allow create: if isClientUser() && request.resource.data.clientId == request.auth.token.clientId;
        
        // Staffing admin can read and update all requests.
        allow read, update: if isStaffingAdmin();
    }
    
    // Client intake and signing process documents.
     match /client_signups/{signupId} {
      allow read, create, update: if isAnyAdmin() || request.auth.token.email == resource.data.formData.clientEmail;
      allow delete: if isAnyAdmin();
    }

    // Referral Program collections
    match /referral_profiles/{profileId} {
      allow read: if isClientUser() && request.auth.token.clientId == resource.data.clientId;
      allow create, update, delete: if isOwner();
    }
    match /referrals/{referralId} {
      allow read: if isClientUser() || isOwner();
      allow create, update, delete: if isOwner();
    }
    match /rewards/{rewardId} {
      allow read: if isClientUser() && request.auth.token.clientId == resource.data.clientId;
      allow create, update, delete: if isOwner();
    }
    
    /**
     * @description Controls access to initial_contacts. Open for all.
     * @path /initial_contacts/{initialContactId}
     * @allow (get, list) - Any user can view care logs.
     * @allow (create) - Any authenticated user can create a initial_contacts.
     * @deny (update, delete) - No user can update or delete a initial_contacts.
     * @principle Open read access.
     */
    match /initial_contacts/{initialContactId} {
      allow get, list: if true;
      allow create, update: if isAnyAdmin();
      allow delete: if false;
    }
    /**
     * @description Controls access to video_checkin_requests. Open for all.
     * @path /video_checkin_requests/{videoCheckinRequestId}
     * @allow (get, list) - Any user can video_checkin_requests.
     * @allow (create) - Any authenticated user can create a video_checkin_requests.
     * @deny (update, delete) - No user can update or delete a video_checkin_requests.
     * @principle Open read access.
     */
    match /video_checkin_requests/{videoCheckinRequestId} {
      allow get, list: if true;
      allow create, update: if isStaffingAdmin() || (isClientUser() && request.resource.data.clientId == request.auth.token.clientId);
      allow delete: if false;
    }
    /**
     * @description Controls access to rewards. Open for all.
     * @path /rewards/{rewardsId}
     * @allow (get, list) - Any user can rewards.
     * @allow (create) - Any authenticated user can create a rewards.
     * @deny (update, delete) - No user can update or delete a rewards.
     * @principle Open read access.
     */
    match /rewards/{rewardsId} {
      allow get, list: if true;
      allow create, update: if isAnyAdmin();
      allow delete: if false;
    }
    /**
     * @description Controls access to referrals. Open for all.
     * @path /referrals/{referralsId}
     * @allow (get, list) - Any user can referrals.
     * @allow (create) - Any authenticated user can create a referrals.
     * @deny (update, delete) - No user can update or delete a referrals.
     * @principle Open read access.
     */
    match /referrals/{referralsId} {
      allow get, list: if true;
      allow create, update: if isAnyAdmin();
      allow delete: if false;
    }
     /**
     * @description Controls access to referrals. Open for all.
     * @path /referral_profiles/{profileId}
     * @allow (get, list) - Any user can referral_profiles.
     * @allow (create) - Any authenticated user can create a referral_profiles.
     * @deny (update, delete) - No user can update or delete a referral_profiles.
     * @principle Open read access.
     */
    match /referral_profiles/{profileId} {
      allow get, list: if true;
      allow create, update: if isAnyAdmin();
      allow delete: if false;
    }
    
    // Campaign templates can be read and managed only by the Owner.
    match /campaign_templates/{templateId} {
      allow read, write: if isOwner();
    }
    /**
     * @description Controls access to level_of_care_assessments. Open for all.
     * @path /level_of_care_assessments/{assessmentsId}
     * @allow (get, list) - Any user can level_of_care_assessments.
     * @allow (create) - Any authenticated user can create a level_of_care_assessments.
     * @deny (update, delete) - No user can update or delete a level_of_care_assessments.
     * @principle Open read access.
     */
    match /level_of_care_assessments/{assessmentsId} {
      allow get, list: if true;
      allow create, update: if isSignedIn();
      allow delete: if false;
    }
    /**
     * @description Controls access to sms_history. Open for all.
     * @path /initial_contacts/{initialContactId}/sms_history/{smsHistoryId}
     * @allow (get, list) - Any user can sms_history.
     * @allow (create) - Any authenticated user can create a sms_history.
     * @deny (update, delete) - No user can update or delete a sms_history.
     * @principle Open read access.
     */
    match /initial_contacts/{initialContactId}/sms_history/{smsHistoryId} {
      allow get, list: if true;
      allow create, update: if isSignedIn();
      allow delete: if false;
    }
  }
}
