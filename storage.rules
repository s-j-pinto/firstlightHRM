rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // --- Helper Functions ---
    // These functions centralize checks for different admin roles based on their email.
    // Note: This pattern requires that admin emails are known or can be fetched.
    // For this app, we will assume they are known or will be managed via custom claims in a future step if needed.
    // The emails here should match the ones used in your application's environment variables.
    function isOwner() {
      return request.auth.token.email == 'lpinto@firstlighthomecare.com';
    }
    function isHrAdmin() {
      return request.auth.token.email == 'care-rc@firstlighthomecare.com';
    }
    function isStaffingAdmin() {
      return request.auth.token.email == 'admin-rc@firstlighthomecare.com';
    }
    function isAnyAdmin() {
      return request.auth != null && (isOwner() || isHrAdmin() || isStaffingAdmin());
    }

    // Default Deny: Disallow all reads and writes by default for security.
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // --- Public Assets ---
    // Allow public read access to specific public assets like logos and waivers.
    // Only authenticated admins can modify these files.
    match /FirstlightLogo_transparent.png {
      allow read: if true;
      allow write: if isAnyAdmin();
    }
    match /FirstLight_Logo_VRT_CMYK_ICO.ico {
       allow read: if true;
       allow write: if isAnyAdmin();
    }
    match /waivers/{allPaths=**} {
      allow read: if true;
      allow write: if isAnyAdmin();
    }

    // --- Client Agreements ---
    // Agreements are stored at 'client-agreements/{fileName}.pdf'.
    match /client-agreements/{fileName} {
      // Allow READ access if:
      // 1. The user is any type of admin.
      // 2. The user's UID (request.auth.uid) matches the `ownerUid` metadata on the file.
      allow read: if request.auth != null && (
                    isAnyAdmin() || request.auth.uid == resource.metadata.ownerUid
                  );
      
      // Allow WRITE access (create, update, delete) only for admins.
      // This secures the upload process.
      allow write: if isAnyAdmin();
    }
  }
}
